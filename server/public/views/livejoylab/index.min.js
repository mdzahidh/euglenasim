!function(){"use strict";app=app||{},$(document).ready(function(){app.mainView=new app.MainView}),app.User=Backbone.Model.extend({idAttribute:"_id",url:"/livejoylab/"}),app.MainView=Backbone.View.extend({el:".page .container",events:{},hadJoyActivity:!1,roughLabStartDate:null,isSocketInitialized:!1,ledsSetObj:null,timeForLab:0,timeInLab:0,timeLeftInLab:0,wasTimeSetFromUpdate:!1,updateLoopInterval:null,getLedsSetObj:function(){return null===app.mainView.ledsSetObj?null:JSON.parse(JSON.stringify(app.mainView.ledsSetObj))},setLedsFromLightValues:function(a,b,c){var d=app.mainView.myJoyStick.getXyFromLightValues(a,c+"->setLedsFromLightValues"),e=app.mainView.getLedsSetObj();e.metaData.clientTime=(new Date).getTime(),e.metaData.layerX=d.x,e.metaData.layerY=d.y,e.metaData.evtType=b,e.metaData.touchState=app.mainView.myJoyStickObj.touchState,e.metaData.previousTouchState=c,e.metaData.radius=0,e.metaData.angle=0,e.topValue=0,e.rightValue=0,e.bottomValue=0,e.leftValue=0,app.mainView.setLedsFromObjectAndSendToServer(e,c+"->setLedsFromLightValues")},lastSetLedsFromEventDate:(new Date).getTime(),setLedsFromEventInterval:30,setLedsFromEvent:function(a,b,c){var d=new Date;if(d-app.mainView.lastSetLedsFromEventDate>=app.mainView.setLedsFromEventInterval){app.mainView.lastSetLedsFromEventDate=d;var e=app.mainView.getLedsSetObj();e.metaData.clientTime=app.mainView.lastSetLedsFromEventDate.getTime(),e.metaData.layerX=a.layerX,e.metaData.layerY=a.layerY,e.metaData.clientX=a.clientX,e.metaData.clientY=a.clientY,e.metaData.className=a.target.className,e.metaData.evtType=b,e.metaData.touchState=app.mainView.myJoyStickObj.touchState,e.metaData.previousTouchState=c,e=app.mainView.setLedsFromObjectAndSendToServer(e,c+"->setLedsFromEvent")}},setLedsFromObjectAndSendToServer:function(a,b){a.metaData.radius=0,a.metaData.angle=0,a.topValue=0,a.rightValue=0,a.bottomValue=0,a.leftValue=0,a=app.mainView.myJoyStick.setLightValuesFromXY(a,b+"->setLedsFromObjectAndSendToServer"),app.userSocketClient.ledsSet(a)},alreadyKicked:!1,kickUser:function(a,b){a&&console.log("kickUser",a,b),app.mainView.alreadyKicked||(app.mainView.alreadyKicked=!0,clearInterval(app.mainView.updateLoopInterval),location.href="/account/textJoin_userexperiments")},setTimeLeftInLabLabel:function(a,b,c){c?app.mainView.timeLeftInLab=a:app.mainView.timeLeftInLab-=b,app.mainView.timeInLab+=b;var d=app.mainView.bpu.get("name")+" Time Remaining:";if(app.mainView.timeLeftInLab>0)if(null===app.mainView.timeLeftInLab)d+="unknown seconds.";else{var e=Math.round(app.mainView.timeLeftInLab/1e3);d+=app.mainView.wasTimeSetFromUpdate?e+" seconds.":"~"+e+" seconds."}else c||app.mainView.wasTimeSetFromUpdate?(d+=" Lab Over.",setTimeout(function(){app.mainView.kickUser(null,"A setTimeLeftInLabLabel")},1e3)):d+=app.mainView.wasTimeSetFromUpdate?"0 seconds.":"~0 seconds.";var f=app.mainView.$el.find('[name="timeLeftInLab"]')[0];f&&(f.innerHTML=d)},initialize:function(){window.dispatchEvent(new Event("resize")),app.mainView=this,app.mainView.user=new app.User(JSON.parse(unescape($("#data-user").html()))),app.mainView.bpu=new app.User(JSON.parse(unescape($("#data-bpu").html()))),app.mainView.bpuExp=new app.User(JSON.parse(unescape($("#data-bpuExp").html()))),app.mainView.bpuExp.attributes.exp_eventsToRun.sort(function(a,b){return b.time-a.time}),app.mainView.timeForLab=app.mainView.bpuExp.attributes.exp_eventsToRun[0].time,app.mainView.setTimeLeftInLabLabel(app.mainView.timeForLab,0,!0);var a={timeoutInterval:1e4,username:app.mainView.user.get("username"),userID:app.mainView.user.get("_id"),bpuID:app.mainView.bpu.get("_id"),sessionID:app.mainView.user.attributes.sessionID,liveBpuExperimentID:app.mainView.bpuExp.id};app.userSocketClient.setConnection(a,function(a,b){a?(app.mainView.isSocketInitialized=!1,app.mainView.kickUser(a,"initialize setConnection")):(app.userSocketClient.startUpdateBpus(),app.mainView.ledsSetObj=b,app.mainView.myLightsObj.build(function(a,b){app.mainView.myJoyStickObj.build(function(a,b){app.mainView.isSocketInitialized=!0,app.mainView.myJoyStickObj.doesExist?(app.mainView.myJoyStick.toggleJoystick("on"),app.mainView.setupMouseEvents(function(a,b){app.mainView.setupKeyboardEvents(function(a,b){app.mainView.startUpdateLoop()})})):app.mainView.setupKeyboardEvents(function(a,b){app.mainView.startUpdateLoop()})})}))})},startUpdateLoop:function(){var a=(new Date).getTime(),b=a,c=a-b,d=0;app.mainView.updateLoopInterval=setInterval(function(){a=(new Date).getTime(),c=a-b,b=a,d+=c,app.mainView.setTimeLeftInLabLabel(null,c,!1),app.mainView.timeInLab>1.25*app.mainView.timeForLab?(app.mainView.kickUser(null,"updateLoopInterval time up"),clearInterval(app.mainView.updateLoopInterval)):app.mainView.isSocketInitialized&&!app.mainView.hadJoyActivity?d>1e3&&(d=0,"canvas-joystick-off"===app.mainView.myJoyStick.canvas.className?app.mainView.myJoyStick.toggleJoystick("on"):app.mainView.myJoyStick.toggleJoystick("off")):d=0,app.mainView.myJoyStick.update("Joystick")},20)},myJoyStick:null,myJoyStickObj:{touchState:"up",doesExist:!1,build:function(a){app.mainView.$el.find('[name="myJoystick"]')[0]&&(app.mainView.myJoyStickObj.doesExist=!0,app.mainView.myJoyStick=new Canvas_Joystick(app.mainView.$el.find('[name="myJoystick"]')[0])),a(null,null)}},myLights:null,myLightsObj:{doesExist:!1,build:function(a){app.mainView.$el.find('[name="myTopLight"]')[0]&&app.mainView.$el.find('[name="myRightLight"]')[0]&&app.mainView.$el.find('[name="myBottomLight"]')[0]&&app.mainView.$el.find('[name="myLeftLight"]')[0]&&(app.mainView.myLightsObj.doesExist=!0,app.mainView.myLights={},app.mainView.myLights.top=app.mainView.$el.find('[name="myTopLight"]')[0],app.mainView.myLights.right=app.mainView.$el.find('[name="myRightLight"]')[0],app.mainView.myLights.bottom=app.mainView.$el.find('[name="myBottomLight"]')[0],app.mainView.myLights.left=app.mainView.$el.find('[name="myLeftLight"]')[0]),a(null,null)},update:function(a){app.mainView.myLightsObj.doesExist&&(app.mainView.myLights.top.style.backgroundColor="rgba(255,255,0,"+a.topValue/100+")",app.mainView.myLights.right.style.backgroundColor="rgba(255,255,0,"+a.rightValue/100+")",app.mainView.myLights.bottom.style.backgroundColor="rgba(255,255,0,"+a.bottomValue/100+")",app.mainView.myLights.left.style.backgroundColor="rgba(255,255,0,"+a.leftValue/100+")",app.mainView.myLights.top.innerHTML=a.topValue,app.mainView.myLights.right.innerHTML=a.rightValue,app.mainView.myLights.bottom.innerHTML=a.bottomValue,app.mainView.myLights.left.innerHTML=a.leftValue)}},zeroLeds:{topValue:0,rightValue:0,bottomValue:0,leftValue:0},lastMouseMoveTime:(new Date).getTime(),setLedsEventController:function(a,b){var c=""+app.mainView.myJoyStickObj.touchState;"mousedown"===b?(app.mainView.hadJoyActivity=!0,app.mainView.myJoyStick.toggleJoystick("on"),app.mainView.myJoyStickObj.touchState="down",app.mainView.setLedsFromEvent(a,b,c)):"mousemove"===b?"down"===app.mainView.myJoyStickObj.touchState&&(new Date).getTime()-app.mainView.lastMouseMoveTime>20&&(app.mainView.lastMouseMoveTime=(new Date).getTime(),app.mainView.setLedsFromEvent(a,b,c)):"mouseout"===b?(app.mainView.myJoyStickObj.touchState="up",app.mainView.myJoyStick.toggleJoystick("off"),app.mainView.setLedsFromLightValues(app.mainView.zeroLeds,b,c)):"mouseup"===b?(app.mainView.myJoyStickObj.touchState="up",app.mainView.myJoyStick.toggleJoystick("off"),app.mainView.setLedsFromLightValues(app.mainView.zeroLeds,b,c)):"resize"===b?(app.mainView.myJoyStickObj.touchState="up",app.mainView.myJoyStick.toggleJoystick("off"),app.mainView.setLedsFromLightValues(app.mainView.zeroLeds,b,c)):"myJoyKeys_loop"===b&&(app.mainView.myJoyStick.toggleJoystick("on"),app.mainView.setLedsFromLightValues(a,b,c))},myJoyKeys:null,setupKeyboardEvents:function(a){app.mainView.myJoyKeys={updateTime:20,deltaValue:2,areKeysRunning:!1,runKeys:function(){var a=app.mainView.myJoyKeys;if(!this.areKeysRunning){this.areKeysRunning=!0;var b=function(){setTimeout(function(){if(a.keys.space.isDown)b();else{a.keys.top.isDown&&0===a.keys.bottom.value?a.keys.top.value<100&&(a.keys.top.value+=a.deltaValue):a.keys.top.value>0?a.keys.top.value-=a.deltaValue:a.keys.bottom.isDown?a.keys.bottom.value<100&&(a.keys.bottom.value+=a.deltaValue):a.keys.bottom.value>0&&(a.keys.bottom.value-=a.deltaValue),a.keys.right.isDown&&0===a.keys.left.value?a.keys.right.value<100&&(a.keys.right.value+=a.deltaValue):a.keys.right.value>0?a.keys.right.value-=a.deltaValue:a.keys.left.isDown?a.keys.left.value<100&&(a.keys.left.value+=a.deltaValue):a.keys.left.value>0&&(a.keys.left.value-=a.deltaValue);var c={};c.topValue=a.keys.top.value,c.bottomValue=a.keys.bottom.value,c.rightValue=a.keys.right.value,c.leftValue=a.keys.left.value,c.topValue+c.bottomValue+c.rightValue+c.leftValue>0?(app.mainView.setLedsEventController(c,"myJoyKeys_loop",app.mainView.myJoyStickObj.touchState),b()):(app.mainView.setLedsEventController(c,"myJoyKeys_loop",app.mainView.myJoyStickObj.touchState),app.mainView.setLedsFromLightValues(c),a.areKeysRunning=!1)}},a.updateTime)};b()}},keys:{top:{pairName:"83",name:"top",key:"w",code:87,isMaster:!0,isDown:!1,value:0},bottom:{pairName:"87",name:"bottom",key:"s",code:83,isMaster:!1,isDown:!1,value:0},right:{pairName:"65",name:"right",key:"d",code:68,isMaster:!0,isDown:!1,value:0},left:{pairName:"68",name:"left",key:"a",code:65,isMaster:!1,isDown:!1,value:0},space:{pairName:null,name:"space",key:"a",code:32,isMaster:!0,isDown:!1,value:0}}},document.addEventListener("keydown",function(a){"down"!==app.mainView.myJoyStickObj.touchState&&Object.keys(app.mainView.myJoyKeys.keys).forEach(function(b){a.keyCode==app.mainView.myJoyKeys.keys[b].code&&(app.mainView.myJoyKeys.keys[b].isDown=!0,app.mainView.myJoyKeys.runKeys())})}),document.addEventListener("keyup",function(a){"down"!==app.mainView.myJoyStickObj.touchState&&Object.keys(app.mainView.myJoyKeys.keys).forEach(function(b){a.keyCode==app.mainView.myJoyKeys.keys[b].code&&(app.mainView.myJoyKeys.keys[b].isDown=!1,app.mainView.myJoyKeys.runKeys())})}),a(null,null)},setupMouseEvents:function(a){window.addEventListener("resize",function(a){var b=app.mainView.$el.find('[name="myJoystick"]')[0];b&&app.mainView.myJoyStick&&app.mainView.myJoyStick.resize(b.clientWidth,b.clientHeight),app.mainView.setLedsEventController(a,"resize")}),document.addEventListener("mousemove",function(a){app.mainView.isSocketInitialized&&app.mainView.hadJoyActivity&&("canvas-joystick-on"!==a.target.className&&"canvas-joystick-off"!==a.target.className||app.mainView.setLedsEventController(a,"mousemove"))},!0),document.addEventListener("mousedown",function(a){app.mainView.isSocketInitialized&&("canvas-joystick-on"!==a.target.className&&"canvas-joystick-off"!==a.target.className||app.mainView.setLedsEventController(a,"mousedown"))},!0),document.addEventListener("mouseup",function(a){app.mainView.isSocketInitialized&&app.mainView.hadJoyActivity&&app.mainView.setLedsEventController(a,"mouseup")},!0),document.addEventListener("mouseout",function(a){app.mainView.isSocketInitialized&&app.mainView.hadJoyActivity&&"page"===a.target.className&&app.mainView.setLedsEventController(a,"mouseout")},!0),window.dispatchEvent(new Event("resize")),a(null,null)}})}();
//# sourceMappingURL=index.min.js.map